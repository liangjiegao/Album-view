<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./layui/css/share.css">
    <link rel="stylesheet" href="./layui/css/top.css">
    <link rel="stylesheet" href="./layui/css/sidebar.css">


</head>
<div class="sidebar" id="sidebar">
    <div class="layui-row">

        <div class="layui-col-md8 layui-col-md-offset2">


            <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                <ul class="layui-tab-title sidebar_text"  id="sidebar_tab">
                    <li class="layui-this">首页</li>
                    <li>我的相册</li>
                    <li>社区动态</li>
                    <li>个人信息</li>
                </ul>

            </div>

        </div>
    </div>
</div>

<body>
<div class="layui-col-md12 top">
    <div class="layui-col-md4">
        <img class="preload-me wf-mobile-hidden"
             src="https://ccdn.goodq.top/caches/85e9413af2fb7f593b2c9e26f027fb64/aHR0cHM6Ly81ZDZjYWM5NThlNzFmLnQ3NC5xaWZlaXllLmNvbS9xZnktY29udGVudC91cGxvYWRzLzIwMTkvMDgvNjY5ZTBhOWMxMjE0ODI4YTcwZWFiOWUyYjM5NTkyMDAtOTAud2VicA_p_p100_p_3D_p_p100_p_3D.webp"
             width="50" height="50" alt="">

    </div>

    <!--            侧边栏点击按钮-->
    <div class="layui-col-md1 layui-col-md-offset7 mane-but" id="mane-but" onclick="openSidebar()">
        <div class="img1" style="background-color: #1d1d1d; width: 20px; height: 2px;">
        </div>
        <div class="img2" style="background-color: #1d1d1d; width: 20px; height: 2px; margin-top: 12px">
        </div>
    </div>


</div>

<div class="layui-container">

        <div class="layui-col-md8">

            <div class="layui-col-md12">
                <div class="layui-tab layui-tab-brief " lay-filter="docDemoTabBrief">
                    <ul class="layui-tab-title layui-col-md3">
                        <li class="layui-this">朋友</li>
                        <li>全部</li>
                    </ul>
                    <div class="layui-tab-content layui-col-md12">
                        <div class="layui-tab-item layui-show friend_list" id="friend_list">

                        </div>
                        <div class="layui-tab-item world_share_list" id="world_share_list">

                        </div>

                    </div>
                </div>
            </div>

        </div>
        <div class="layui-col-md4">
            <div class="layui-col-md8 layui-col-md-offset2 layui-bg-gray friend_info_list_div">
                <div class="layui-col-md4 layui-col-md-offset4 friend_list_title">
                    好友列表
                </div>
                <ul class="" id="friend_info_list_ul">


                </ul>
                <div>
                    <button class="layui-btn layui-btn-normal add_friend layui-col-md4 layui-col-md-offset4">添加好友</button>
                </div>
            </div>
        </div>
    </div>

</body>

<script src="layui/jquery.js"></script>
<script src="layui/layui.js"></script>
<script src="layui/auth.js"></script>
<script src="layui/sidebar.js"></script>

<script>

    layui.use('element', function(){
        var element = layui.element;

        $('.layui-tab-title').on('click', function(title) {

            if ( title.toElement.textContent == '朋友' ){
                getShareList('friend');
                nowTab = 'friend';
            }else if ( title.toElement.textContent == '全部' ){
                getShareList('world');
                nowTab = 'world';
            }

        });

        //…
    });

    let basicURL    = getBasicUrl();
    let token       = getToken();
    let nowTab      = 'friend';

    $(document).ready(() => {
        // 列表信息
        getShareList( 'friend' );
        // getShareList( 'world' );
        getFriendList();
    });

    function getFriendList() {

        $.get(basicURL + `/user/getFriendList?token=${token}`, function(data) {
            // let res = JSON.parse(data);
            let res = {};
            if (typeof data === 'string') {
                res = JSON.parse(data);
            } else {
                res = data
            }
            getData = res['data'] != null ? res['data'] : null;
            if (getData != null) {

                list = getData['list'];

                $("#friend_info_list_ul").empty();
                list.forEach((item) => {

                    $("#friend_info_list_ul").append(
                        '<li>' +
                        '                        <div class="layui-col-md12 friend_item">' +
                        '                            <img src="'+ item['icon'] +'" class ="layui-col-md2 friend_head">' +
                        '                            <div class="layui-col-md3 layui-col-md-offset1">' +
                        '                                <span class="layui-col-md12">'+ item['nickname'] +'</span>' +
                        '                                <span class="layui-col-md12 remark">'+ item['remark'] +'</span>' +
                        '                            </div>' +
                        '                        </div>' +
                        '                    </li>'
                    );
                });

            }


        });
    }

    function getShareList( list_type ) {

        $.get(basicURL + `/share/getShareList?token=${token}&list_type=${list_type}`, function(data) {
            // let res = JSON.parse(data);
            let res = {};
            if (typeof data === 'string') {
                res = JSON.parse(data);
            } else {
                res = data
            }

            getData = res['data'] != null ? res['data'] : null;
            if (getData != null) {

                list = getData['list'];

                let id = 'friend_list';
                if ( list_type === 'friend' ){
                    id = 'friend_list';
                }else if ( list_type === 'world' ){
                    id = 'world_share_list';
                }

                $("#" + id).empty();
                list.forEach((item) => {
                    var shareTime   = new Date(parseInt(item['create_time']) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');

                    // 点赞信息
                    var upList      = item['up_account'];
                    var upListHtml = '';
                    if ( upList != null  ){
                        upList.forEach((item) => {
                            if ( upListHtml.length > 0 ){
                                item['nickname'] = "，" + item['nickname'] ;
                            }
                            upListHtml += '<li>'+ item['nickname'] +'</li>';
                        });
                    }

                    if ( upListHtml !== '' ){
                        upListHtml = '<i class="layui-icon layui-icon-heart-fill up_list_icon"></i>' + upListHtml
                    }

                    // 评论信息
                    var commentList     = item['comment_list'];
                    var commentListHtml = '';
                    if ( commentList != null  ){
                        commentList.forEach((item) => {
                            commentListHtml += '<li>'+ item['user_info']['nickname'] + ':' + item['comment_info'] +'</li>';
                        });
                    }


                    $("#" + id).append(
                        '                            <div class="layui-col-md12 item">' +
                        '                                <div class="layui-col-md1 head_div">' +
                        '                                    <img src="'+item['share_user_info']['icon']+'" class="head">' +
                        '                                </div>' +
                        '                                <div class="layui-col-md6 nickname_div">' +
                        '                                    <span>'+item['share_user_info']['nickname']+'</span>' +
                        '                                </div>' +
                        '                                <div class="layui-col-md6 info_div">' +
                        '                                    <span>'+item['info']+'</span>' +
                        '                                </div>' +
                        '                                <div class="layui-col-md5 layui-col-md-offset1 img_group_div">' +
                        '                                    <div class="layui-col-md10">' +
                        '                                        <img src="'+item['url']+'" class="img">' +
                        '                                    </div>' +
                        '                                    <div class="up_comment">' +
                        '                                        <div class="layui-icon layui-icon-praise up" value = "'+ item['share_key'] +'" onclick="up( this )"></div>' +
                        '                                        <div class="layui-icon layui-icon-reply-fill comment" value = "'+ item['share_key'] +'" onclick="clickComment( this )"></div>' +
                        '                                    </div>' +
                        '                                </div>' +
                        '                                <div class="layui-col-md11 layui-col-md-offset1 time">' +
                        '                                    '+shareTime+'' +
                        '                                </div>' +
                        '                                <div class="layui-col-md6 layui-col-md-offset1 layui-bg-gray up_list">' +
                        '                                    <ul>' +
                                                            upListHtml+
                        '                                    </ul>' +
                        '                                </div>' +
                        '                                <div class="layui-col-md6 layui-col-md-offset1 layui-bg-gray comment_list">' +
                        '                                    <div>' +
                        '                                        <ul>'  +
                                                        commentListHtml +
                        '                                        </ul>' +
                        '                                    </div>' +
                        '                                </div>' +
                        '                            </div>'
                    );

                });

            }

        });


    }

    function up( ele ) {

        let share_key = $(ele).attr('value');
        let data = {};
        data['token']       = token;
        data['share_key']   = share_key;

        $.post(basicURL + `/share/upShare`, data, function(data) {

            if(typeof data === 'string'){
                res = JSON.parse(data);
            }else{
                res = data
            }
            if(res.code === 10000){
                alert('点赞成功');
            }else {
                alert(res.msg);
            }

        });
        getShareList( 'friend' );
    }

    function clickComment( ele ) {

        layui.use('layer', function () {
            var layer = layui.layer;

            layer.confirm('<input class="layui-input-inline" id="comment_content">', {
                btn: ['确定'] //可以无限个按钮
                , yes: function(index, layero){
                    comment( ele, layer, index );
                }
            ,cancel: function(){
                //右上角关闭回调

            }});
        });

    }

    function comment( ele , layer, index) {

        let share_key   = $(ele).attr('value');
        let content     = $('#comment_content').val();
        let data = {};
        data['token']           = token;
        data['share_key']       = share_key;
        data['comment_info']    = content;

        $.post(basicURL + `/share/commentShare`, data, function(data) {

            if(typeof data === 'string'){
                res = JSON.parse(data);
            }else{
                res = data
            }
            if(res.code === 10000){
                alert('评价成功');
                getShareList( nowTab );
                layer.close(index)
            }else {
                alert(res.msg);
            }

        });
    }


</script>


</html>
